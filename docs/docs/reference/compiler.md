# コンパイラについて

## 利用方法

以下は Shol コンパイラの最も一般的な利用方法です。

```sh
shol myscript.shol
```

`myscript.shol` から実行可能ファイルが生成されます。

### オプション

Shol コンパイラにはいくつかのオプションを指定することができます。

- **`-h`, `--help`**

    コマンドのヘルプメッセージを表示します。

- **`-o FILENAME`**

    出力ファイル名を指定します。\
    `--rs` との併用時には、Rust のファイル名を指定します。

- **`--rs`**

    Rust ファイルを生成します。\
    実行可能ファイルは生成されません。

- **`-S`, `--save-temps`**

    中間生成ファイルを保持します。\
    主にコンパイラのデバッグに使用します。

- **`--log`**

    コンパイル過程のログを出力します。\
    JSON 形式の AST や型推論の様子などが出力されます。\
    主にコンパイラのデバッグに使用します。

## コンパイルの流れ

Shol コンパイラは、バックエンドとして Rust をターゲットとし、Rust のコンパイラ (rustc) を利用してバイナリを生成しています。\
Shol コンパイラの内部で行われる処理の流れの詳細は以下の通りです。

1. **プリプロセス**

    入力されたプログラムに、いくつかの前処理を行います。

1. **AST の生成**

    字句解析と構文解析を行い、抽象構文木（AST）を生成します。

1. **意味解析**

    AST を解析し、条件式の種別やキャプチャの型の推論などを行います。

1. **コード生成**

    AST から、Rust コードを生成します。

1. **rustc コンパイル**

    生成された Rust コードを rustc でコンパイルし、実行可能ファイルを生成します。\
    `--rs` オプションを指定した場合には、このステップはスキップされます。

## プリプロセス

### 特記事項

- コンパイルエラー内で表示されるプログラムは、プリプロセス後のプログラムです。

- プリプロセス結果は、`-S` オプションを指定することで確認することができます。

    ```sh
    shol -S myscript.shol
    ```

    プリプロセス後のプログラムは、`myscript.shi` に保存されます。

### 処理内容

入力されたソースに、以下の前処理を順に行います。

1. **末尾に改行を追加**

    ファイルの末尾に改行がない場合、改行を追加します。\
    これは構文解析のために、文法の都合上、必要な処理です。

2. **バックスラッシュで分割された行を 1 行に結合**

    バックスラッシュで行が分割されている場合、1 行に結合します。

    コンパイルエラーで行番号がずれるのを防ぐため、結合されると消えてしまう行には空行が挿入されます。\
    例えば、以下のようなプログラムがある場合、

    ```shol
    %print
    "Hello, \
    World!"
    "Hi!"
    ```

    プリプロセス後は以下のようになります。

    ```shol
    %print
    "Hello, World!"

    "Hi!"
    ```

3. **ダブルクォートが省略された文字列リソース行をダブルクォートで囲む**

    ダブルクォートで囲まれていない文字列リソース行を、ダブルクォートで囲みます。

    例えば、以下のようなプログラムがある場合、

    ```shol
    %print
    Hello, World!
    ```

    プリプロセス後は以下のようになります。

    ```shol
    %print
    "Hello, World!"
    ```







